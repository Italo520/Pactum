{% extends 'base/base.html' %}

{% block title %}Histórico de Pagamentos - FUNETEC{% endblock %}
{% block page_title %}Histórico de Pagamentos{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- KPI Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="p-6 bg-blue-600 text-white rounded-xl shadow-lg text-center">
            <i class="fas fa-money-bill-wave fa-2x mb-2"></i>
            <h5 class="font-semibold">Total Recebido</h5>
            <h3 class="text-3xl font-bold">R$ {{ total_valor|floatformat:2 }}</h3>
        </div>
        <div class="p-6 bg-green-600 text-white rounded-xl shadow-lg text-center">
            <i class="fas fa-check-circle fa-2x mb-2"></i>
            <h5 class="font-semibold">Total de Pagamentos</h5>
            <h3 class="text-3xl font-bold">{{ total_count }}</h3>
        </div>
        <div class="p-6 bg-teal-600 text-white rounded-xl shadow-lg text-center">
            <i class="fas fa-calendar-alt fa-2x mb-2"></i>
            <h5 class="font-semibold">Média Mensal</h5>
            <h3 class="text-3xl font-bold">R$ {{ media_mensal|floatformat:0 }}</h3>
        </div>
        <div class="p-6 bg-yellow-600 text-white rounded-xl shadow-lg text-center">
            <i class="fas fa-chart-line fa-2x mb-2"></i>
            <h5 class="font-semibold">Último Pagamento</h5>
            <h3 class="text-3xl font-bold">{% if payments %}{{ payments.0.data_pagamento|date:"d/m" }}{% else %}N/A{% endif %}</h3>
        </div>
    </div>

    <!-- Filtros -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center"><i class="fas fa-filter mr-2"></i>Filtros</h5>
        </div>
        <div class="p-4">
            <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="year" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ano</label>
                    <select id="year" name="year" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos os anos</option>
                        <option value="2025" {% if year_filter == "2025" %}selected{% endif %}>2025</option>
                        <option value="2024" {% if year_filter == "2024" %}selected{% endif %}>2024</option>
                        <option value="2023" {% if year_filter == "2023" %}selected{% endif %}>2023</option>
                    </select>
                </div>
                <div>
                    <label for="month" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Mês</label>
                    <select id="month" name="month" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos os meses</option>
                        {% for month_num, month_name in months %}
                        <option value="{{ month_num }}" {% if month_filter == month_num|stringformat:"s" %}selected{% endif %}>{{ month_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="md:col-span-1">
                    <label for="contrato" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contrato</label>
                    <select id="contrato" name="contrato" class="mt-1 block w-full py-2 px-3 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos os contratos</option>
                        {% for contrato_id, contrato_num in contratos_options %}
                        <option value="{{ contrato_id }}" {% if contrato_filter == contrato_id|stringformat:"s" %}selected{% endif %}>{{ contrato_num }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <button type="submit" class="w-full inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-search mr-2"></i>Filtrar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabela de Pagamentos -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl overflow-hidden">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
            <h5 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center">
                <i class="fas fa-list mr-2"></i>Pagamentos Recentes
                {% if total_count %}<span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">{{ total_count }}</span>{% endif %}
            </h5>
            <div class="space-x-2">
                <a href="{% url 'contratos:parcela_list' %}" class="px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                    <i class="fas fa-eye mr-1"></i>Ver Parcelas
                </a>
                <a href="{% url 'dashboard:analytics_financeiro' %}" class="px-3 py-1 border border-transparent rounded-md text-sm font-medium text-blue-700 bg-blue-100 hover:bg-blue-200 dark:bg-blue-900 dark:text-blue-300 dark:hover:bg-blue-800">
                    <i class="fas fa-chart-bar mr-1"></i>Analytics
                </a>
            </div>
        </div>

        {% if payments %}
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
                    <tr>
                        <th scope="col" class="px-6 py-3">Data</th>
                        <th scope="col" class="px-6 py-3">Contrato</th>
                        <th scope="col" class="px-6 py-3">Parcela</th>
                        <th scope="col" class="px-6 py-3">Valor Pago</th>
                        <th scope="col" class="px-6 py-3">Valor Total</th>
                        <th scope="col" class="px-6 py-3">Status</th>
                        <th scope="col" class="px-6 py-3">ID</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                        <td class="px-6 py-4">
                            <span class="font-semibold text-gray-900 dark:text-white">{{ payment.data_pagamento|date:"d/m/Y" }}</span><br>
                            <small class="text-gray-500 dark:text-gray-400">{{ payment.data_pagamento|date:"l" }}</small>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-semibold text-gray-900 dark:text-white">{{ payment.num_contrato.num_contrato|default:"N/A" }}</span><br>
                            <small class="text-gray-500 dark:text-gray-400">{{ payment.num_contrato.contratado|default:"Sem contratado"|truncatechars:20 }}</small>
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-200 text-gray-800 dark:bg-gray-600 dark:text-gray-200">{{ payment.num_parcela }}ª</span><br>
                            <small class="text-gray-500 dark:text-gray-400">Lanç. {{ payment.cod_lancamento }}</small>
                        </td>
                        <td class="px-6 py-4">
                            <span class="font-semibold text-green-600 dark:text-green-400">R$ {{ payment.valor_pago|floatformat:2 }}</span>
                            {% if payment.valor_pago < payment.valor_parcela %}
                            <br><small class="text-yellow-600 dark:text-yellow-400">Pagamento Parcial</small>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="text-gray-600 dark:text-gray-300">R$ {{ payment.valor_parcela|floatformat:2 }}</span>
                            {% if payment.valor_pago < payment.valor_parcela %}
                            <br><small class="text-red-600 dark:text-red-400">Resta: R$ {{ payment.valor_parcela|add:0|floatformat:2 }}</small>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            {% if payment.situacao == "3" or payment.valor_pago >= payment.valor_parcela %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Pago</span>
                            {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Parcial</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">ID {{ payment.pk }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if total_count > 50 %}
        <div class="p-4 border-t border-gray-200 dark:border-gray-700">
            <div class="bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 rounded-r-lg">
                <p class="text-sm text-blue-700 dark:text-blue-300">
                    <i class="fas fa-info-circle mr-2"></i>
                    <strong>Mostrando os 50 pagamentos mais recentes.</strong>
                    Use os filtros acima para refinar a busca ou acesse a
                    <a href="{% url 'contratos:parcela_list' %}" class="font-medium hover:underline">lista completa de parcelas</a>.
                </p>
            </div>
        </div>
        {% endif %}
        
        {% else %}
        <div class="text-center py-12">
            <i class="fas fa-search fa-3x text-gray-400 dark:text-gray-500 mb-3"></i>
            <h5 class="text-lg font-medium text-gray-600 dark:text-gray-300">Nenhum pagamento encontrado</h5>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">
                {% if year_filter or month_filter or contrato_filter %}
                Nenhum pagamento corresponde aos filtros selecionados.
                <a href="{% url 'pagamentos:payment_history' %}" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <i class="fas fa-times mr-2"></i>Limpar Filtros
                </a>
                {% else %}
                Ainda não há pagamentos registrados no sistema.
                <a href="{% url 'contratos:parcela_list' %}" class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700">
                    <i class="fas fa-plus mr-2"></i>Registrar Pagamento
                </a>
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>

    <!-- Resumo Mensal -->
    {% if monthly_summary %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl mt-6">
        <div class="p-4 border-b border-gray-200 dark:border-gray-700">
            <h5 class="text-lg font-semibold text-gray-800 dark:text-white flex items-center"><i class="fas fa-calendar mr-2"></i>Resumo Mensal {{ current_year }}</h5>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
                {% for summary in monthly_summary %}
                <div class="text-center p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <div class="font-bold text-gray-800 dark:text-white">
                        {% if summary.month == 1 %}Jan{% elif summary.month == 2 %}Fev{% elif summary.month == 3 %}Mar{% elif summary.month == 4 %}Abr{% elif summary.month == 5 %}Mai{% elif summary.month == 6 %}Jun{% elif summary.month == 7 %}Jul{% elif summary.month == 8 %}Ago{% elif summary.month == 9 %}Set{% elif summary.month == 10 %}Out{% elif summary.month == 11 %}Nov{% elif summary.month == 12 %}Dez{% endif %}
                    </div>
                    <div class="text-green-600 dark:text-green-400 font-bold">R$ {{ summary.total|floatformat:0 }}</div>
                    <small class="text-gray-500 dark:text-gray-400">{{ summary.count|floatformat:0 }} pag.</small>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}